<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      /* Основные стили */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }

      body {
        background-color: #f5f5f5;
        color: #333;
        display: flex;
      }

      /* Стили для боковой панели */
      #sidebar {
        width: 300px;
        background-color: #4CAF50;
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        border-top-right-radius: 10px;
        border-bottom-right-radius: 10px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      /* Заголовок бокового меню, стиль шрифта и подсветка */
      #sidebar h3 {
        margin-bottom: 20px;
        font-weight: bold;
        font-size: 20px;
        color: rgba(255, 255, 255, 0.898);
        letter-spacing: 1px;
        text-shadow: 1px 1px 5px hwb(197 0% 0% / 0.747);
        border: 1px solid hsla(180, 60%, 64%, 0.898);  /* Добавление рамки */
        padding: 10px; /* Отступы внутри рамки */
        border-radius: 8px; /* Скругление углов рамки */
        background-color: #31b975; /* Полупрозрачный фон для выделения */
      }

      /* Стили для списка видео */
      #videoList {
        list-style-type: grid;
        padding: 0;
        width: 100%;
      }

      /* Стили для элементов списка */
      #videoList li {
        background-color: #388E3C;
        padding: 10px;
        margin-bottom: 10px;
        margin-right: 20px;
        display: flex;
        align-items: center;
        border-radius: 8px;
        height: 40px;
        box-sizing: border-box;
        overflow: hidden;
        justify-content: space-between;
        cursor: pointer;
      }

      #videoList li:hover {
        background-color: #2e7d32;
        width: 93%;
        margin-left: 5px;
      }

      /* Стили для текста с обрезанием */
      .video-title {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 10px;
      }

      /* Стили для разделительной линии */
      .separator {
        width: 1px;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.3);
      }

      /* Стили для кнопки удаления */
      .delete-area {
        display: flex;
        align-items: center;
        padding: 0 10px;
        height: 100%;
        cursor: pointer;
      }

      /* Стили для крестика удаления */
      .delete-btn {
        color: white;
        font-size: 16px;
        border: none;
        background: none;
        cursor: pointer;
        transition: color 0.3s;
      }

      /* Подсветка только крестика при наведении */
      .delete-area:hover .delete-btn {
        color: red;
      }

      #mainContent {
        margin-left: 290px;
        padding: 20px;
        flex-grow: 1;
        display: grid;
        grid-template-columns: repeat(300px, 2fr);
        gap: 10px;
    }

    </style>
  </head>
  <body>
    <div id="sidebar">
      <h3>Доступные трансляции</h3>
      <ul id="videoList"></ul>
    </div>

    <div id="mainContent">
      <div id="remoteVideos"></div>
    </div>

    <script>
      // Получаем список видео по эндпоинту и добавляем его в боковую панель
      fetch("http://localhost:8080/video-list")
        .then(response => response.json())
        .then(videoList => {
          let videoListContainer = document.getElementById("videoList");
          videoList.forEach(video => {
            let li = document.createElement("li");

            // Название видеопотока с обрезанием текста
            let videoTitle = document.createElement("span");
            videoTitle.textContent = video;
            videoTitle.classList.add("video-title");
            videoTitle.onclick = () => startVideoStream(video);

            // Разделительная линия
            let separator = document.createElement("div");
            separator.classList.add("separator");

            // Зона удаления
            let deleteArea = document.createElement("div");
            deleteArea.classList.add("delete-area");
            deleteArea.onclick = (e) => {
              e.stopPropagation();
              deleteVideoStream(video);
            };

            // Кнопка удаления (крестик)
            let deleteBtn = document.createElement("button");
            deleteBtn.innerHTML = "&times;";
            deleteBtn.classList.add("delete-btn");
            deleteArea.appendChild(deleteBtn);

            li.appendChild(videoTitle);
            li.appendChild(separator);
            li.appendChild(deleteArea);
            videoListContainer.appendChild(li);
          });
        })
        .catch(error => console.error("Error fetching video list:", error));

      let pc = new RTCPeerConnection();

      pc.ontrack = function (event) {
        if (event.track.kind === 'audio') {
          return;
        }

        let el = document.createElement(event.track.kind);
        el.srcObject = event.streams[0];
        el.autoplay = true;
        el.controls = true;
        el.style.width = '440px';
        el.style.height = '300px';
        el.style.borderRadius = '8px';
        el.style.boxShadow = '0px 4px 10px rgba(0, 0, 0, 0.15)';

        document.getElementById('remoteVideos').appendChild(el);

        event.track.onmute = function(event) {
          el.play();
        };

        event.streams[0].onremovetrack = ({ track }) => {
          if (el.parentNode) {
            el.parentNode.removeChild(el);
          }
        };
      };

      // Устанавливаем WebSocket-соединение
      let ws = new WebSocket("{{.}}");

      ws.onclose = function(evt) {
        window.alert("WebSocket has closed");
      };

      ws.onmessage = function(evt) {
        let msg = JSON.parse(evt.data);
        if (!msg) {
          return console.log('failed to parse msg');
        }

        switch (msg.event) {
          case 'offer':
            let offer = JSON.parse(msg.data);
            if (!offer) {
              return console.log('failed to parse answer');
            }
            pc.setRemoteDescription(offer);
            pc.createAnswer().then(answer => {
              pc.setLocalDescription(answer);
              ws.send(JSON.stringify({ event: 'answer', data: JSON.stringify(answer) })); 
            });
            return;

          case 'candidate':
            let candidate = JSON.parse(msg.data);
            if (!candidate) {
              return console.log('failed to parse candidate');
            }

            pc.addIceCandidate(candidate);
        }
      };

      ws.onerror = function(evt) {
        console.log("ERROR: " + evt.data);
      };

      // Функция для отправки сообщения "publish" при выборе видео
      function startVideoStream(video) {
        ws.send(JSON.stringify({ event: 'publish', data: JSON.stringify(video) }));
        console.log("Selected video:", video);
      }

      // Функция для удаления видеопотока
      function deleteVideoStream(video) {
        fetch(`http://localhost:8080/delete-video?name=${encodeURIComponent(video)}`, {
          method: "DELETE"
        })
          .then(response => {
            if (response.ok) {
              console.log("Deleted video:", video);
              document.getElementById("videoList").innerHTML = "";
              fetch("http://localhost:8080/video-list")
                .then(response => response.json())
                .then(newVideoList => {
                  newVideoList.forEach(newVideo => {
                    let li = document.createElement("li");

                    let videoTitle = document.createElement("span");
                    videoTitle.textContent = newVideo;
                    videoTitle.classList.add("video-title");
                    videoTitle.onclick = () => startVideoStream(newVideo);

                    let separator = document.createElement("div");
                    separator.classList.add("separator");

                    let deleteArea = document.createElement("div");
                    deleteArea.classList.add("delete-area");
                    deleteArea.onclick = (e) => {
                      e.stopPropagation();
                      deleteVideoStream(newVideo);
                    };

                    let deleteBtn = document.createElement("button");
                    deleteBtn.innerHTML = "&times;";
                    deleteBtn.classList.add("delete-btn");
                    deleteArea.appendChild(deleteBtn);

                    li.appendChild(videoTitle);
                    li.appendChild(separator);
                    li.appendChild(deleteArea);
                    document.getElementById("videoList").appendChild(li);
                  });
                });
            }
          })
          .catch(error => console.error("Error deleting video:", error));
      }
    </script>
  </body>
</html>
