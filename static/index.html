<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      /* Стили для боковой панели */
      #sidebar {
        width: 250px;
        background-color: #4CAF50;
        color: white;
        padding: 10px;
        float: left;
        height: 100vh;
      }

      /* Стили для списка видео */
      #videoList {
        list-style-type: none;
        padding: 0;
      }

      #videoList li {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #FFFFFF;
      }

      #videoList li:hover {
        background-color: #3E8E41;
      }

      /* Стили для основной части страницы */
      #mainContent {
        margin-left: 250px;
        padding: 20px;
      }

      /* Стили для видеоэлемента */
      video {
        width: 440px;
        height: 300px;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <h3>Доступные трансляции</h3>
      <ul id="videoList"></ul>
    </div>

    <div id="mainContent">
      <div id="remoteVideos"></div> <br />
    </div>

    <script>
      // Получаем список видео по эндпоинту и добавляем его в боковую панель
      fetch("http://localhost:8080/video-list")
        .then(response => response.json())
        .then(videoList => {
          let videoListContainer = document.getElementById("videoList");
          videoList.forEach(video => {
            let li = document.createElement("li");
            li.textContent = video;
            li.onclick = () => startVideoStream(video);
            videoListContainer.appendChild(li);
          });
        })
        .catch(error => console.error("Error fetching video list:", error));

      let pc = new RTCPeerConnection();

      pc.ontrack = function (event) {
        if (event.track.kind === 'audio') {
          return;
        }

        let el = document.createElement(event.track.kind);
        el.srcObject = event.streams[0];
        el.autoplay = true;
        el.controls = true;

        el.style.width = '440px';
        el.style.height = '300px';

        document.getElementById('remoteVideos').appendChild(el);

        event.track.onmute = function(event) {
          el.play();
        };

        event.streams[0].onremovetrack = ({ track }) => {
          if (el.parentNode) {
            el.parentNode.removeChild(el);
          }
        };
      };

      // Устанавливаем WebSocket-соединение
      let ws = new WebSocket("{{.}}");

      ws.onclose = function(evt) {
        window.alert("WebSocket has closed");
      };

      ws.onmessage = function(evt) {
        let msg = JSON.parse(evt.data);
        if (!msg) {
          return console.log('failed to parse msg');
        }

        switch (msg.event) {
          case 'offer':
            let offer = JSON.parse(msg.data);
            if (!offer) {
              return console.log('failed to parse answer');
            }
            pc.setRemoteDescription(offer);
            pc.createAnswer().then(answer => {
              pc.setLocalDescription(answer);
              ws.send(JSON.stringify({ event: 'answer', data: JSON.stringify(answer) }));
            });
            return;

          case 'candidate':
            let candidate = JSON.parse(msg.data);
            if (!candidate) {
              return console.log('failed to parse candidate');
            }

            pc.addIceCandidate(candidate);
        }
      };

      ws.onerror = function(evt) {
        console.log("ERROR: " + evt.data);
      };

      // Функция для отправки сообщения "publish" при выборе видео
      function startVideoStream(video) {
        ws.send(JSON.stringify({ event: 'publish', data: JSON.stringify(video) }));
        console.log("Selected video:", video);
      }
    </script>
  </body>
</html>
